<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßã‡¶≤‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã - ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            background-color: #F1F5F9;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
        }

        .tab-btn.active {
            background-color: #059669;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* PDF Styles */
        #pdf-export-container {
            background: white;
        }

        @media print {
            .no-print { display: none !important; }
        }
        
        /* Custom scrollbar for table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body class="text-slate-800 pb-10">

    <!-- Navbar -->
    <nav class="bg-white shadow-md border-b border-slate-200 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center py-3 gap-3">
                
                <div class="flex items-center gap-2">
                    <span class="text-3xl">üê§</span>
                    <div>
                        <h1 class="text-lg font-bold text-emerald-800 leading-tight">‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã</h1>
                        <p class="text-[10px] text-slate-500 uppercase tracking-wider">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ì ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="downloadPDF()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all transform active:scale-95 shadow-sm font-bold text-sm">
                        <span>üì•</span> PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
                    </button>

                    <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                        <select id="batch-selector" onchange="switchBatch()" class="bg-transparent text-emerald-700 font-bold text-sm py-1 px-2 border-0 focus:ring-0 cursor-pointer">
                            <!-- Batches auto-load -->
                        </select>
                        <button onclick="createNewBatch()" class="ml-1 bg-emerald-600 text-white w-7 h-7 rounded-lg hover:bg-emerald-700 flex items-center justify-center font-bold">+</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area to Export -->
    <div id="report-content" class="p-2 sm:p-4">
        <main class="max-w-7xl mx-auto space-y-6">

            <!-- PDF Header (Hidden in UI) -->
            <div id="pdf-header" class="hidden text-center border-b-2 border-emerald-500 pb-4 mb-6">
                <h1 class="text-2xl font-bold text-slate-800">‡¶™‡ßã‡¶≤‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
                <div class="flex justify-between mt-4 px-4 text-sm text-slate-600">
                    <span id="pdf-batch-info"></span>
                    <span id="pdf-date-info"></span>
                </div>
            </div>

            <!-- KPI Summary Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</p>
                    <h3 class="text-xl font-bold text-emerald-600" id="kpi-income">‡ß≥ ‡ß¶</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-500">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡ßü</p>
                    <h3 class="text-xl font-bold text-rose-600" id="kpi-expense">‡ß≥ ‡ß¶</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">‡¶≤‡¶æ‡¶≠/‡¶ï‡ßç‡¶∑‡¶§‡¶ø</p>
                    <h3 class="text-xl font-bold text-slate-700" id="kpi-profit">‡ß≥ ‡ß¶</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-amber-500">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï</p>
                    <h3 class="text-xl font-bold text-amber-600" id="kpi-stock">‡ß¶ ‡¶ü‡¶ø</h3>
                </div>
            </div>

            <!-- Input Form (no-print) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 no-print overflow-hidden">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex flex-wrap justify-between items-center gap-3">
                    <h3 class="font-bold text-slate-700 text-sm">üìù ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø: <span id="form-batch-badge" class="text-emerald-600"></span></h3>
                    <div class="flex bg-slate-200 p-1 rounded-lg">
                        <button onclick="setTab('expense')" id="tab-expense" class="tab-btn active px-3 py-1 rounded-md text-[11px] transition-all">‡¶¨‡ßç‡¶Ø‡ßü</button>
                        <button onclick="setTab('income')" id="tab-income" class="tab-btn px-3 py-1 rounded-md text-[11px] transition-all">‡¶Ü‡ßü</button>
                        <button onclick="setTab('stock')" id="tab-stock" class="tab-btn px-3 py-1 rounded-md text-[11px] transition-all">‡¶∏‡ßç‡¶ü‡¶ï</button>
                    </div>
                </div>
                <div class="p-4">
                    <form id="entry-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                            <input type="date" id="f-date" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                            <select id="f-cat" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm">
                                <!-- Dynamic options -->
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase" id="lbl-qty">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                            <input type="number" id="f-qty" oninput="calculateTotal()" placeholder="‡ß¶" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm">
                        </div>
                        <div class="space-y-1" id="div-amt">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶ü‡¶æ‡¶ï‡¶æ</label>
                            <input type="number" id="f-amt" placeholder="‡ß¶" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm font-bold text-emerald-700">
                        </div>
                        <div>
                            <button type="button" onclick="saveEntry()" class="w-full bg-emerald-600 text-white font-bold py-2 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm text-sm">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Analysis Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Chart Card -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-sm mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø
                    </h3>
                    <div class="chart-container">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>

                <!-- Table Card -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-5 py-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-sm">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
                        <select id="table-filter" onchange="refreshUI()" class="no-print text-[10px] border border-slate-300 rounded px-2 py-1 bg-white">
                            <option value="all">‡¶∏‡¶¨ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</option>
                            <option value="expense">‡¶¨‡ßç‡¶Ø‡ßü ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</option>
                            <option value="income">‡¶Ü‡ßü ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</option>
                            <option value="stock">‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
                                <tr>
                                    <th class="px-5 py-3 font-bold">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                    <th class="px-5 py-3 font-bold">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                    <th class="px-5 py-3 font-bold text-right">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£/‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                    <th class="px-5 py-3 font-bold text-center no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-body" class="divide-y divide-slate-100">
                                <!-- Data rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Core State
        const STATE = {
            batches: JSON.parse(localStorage.getItem('poultry_batches')) || ['Batch-01'],
            activeBatch: localStorage.getItem('poultry_active') || 'Batch-01',
            entries: JSON.parse(localStorage.getItem('poultry_data')) || [],
            currentTab: 'expense'
        };

        let myChart = null;

        // Init
        window.onload = () => {
            document.getElementById('f-date').valueAsDate = new Date();
            updateBatchList();
            setTab('expense');
            refreshUI();
        };

        function updateBatchList() {
            const el = document.getElementById('batch-selector');
            el.innerHTML = STATE.batches.map(b => `<option value="${b}">${b}</option>`).join('');
            el.value = STATE.activeBatch;
        }

        function createNewBatch() {
            const name = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: Batch-02):");
            if (name && !STATE.batches.includes(name)) {
                STATE.batches.push(name);
                STATE.activeBatch = name;
                saveToDisk();
                updateBatchList();
                refreshUI();
            }
        }

        function switchBatch() {
            STATE.activeBatch = document.getElementById('batch-selector').value;
            localStorage.setItem('poultry_active', STATE.activeBatch);
            refreshUI();
        }

        function setTab(tab) {
            STATE.currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const cat = document.getElementById('f-cat');
            const amtDiv = document.getElementById('div-amt');
            
            if(tab === 'expense') {
                cat.innerHTML = `<option value="‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶ï‡ßç‡¶∞‡ßü">‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶ï‡ßç‡¶∞‡ßü</option><option value="‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞">‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞</option><option value="‡¶î‡¶∑‡¶ß/‡¶≠‡ßç‡¶Ø‡¶æ‡¶ï‡¶∏‡¶ø‡¶®">‡¶î‡¶∑‡¶ß/‡¶≠‡ßç‡¶Ø‡¶æ‡¶ï‡¶∏‡¶ø‡¶®</option><option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö</option>`;
                amtDiv.style.display = 'block';
            } else if(tab === 'income') {
                cat.innerHTML = `<option value="‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø">‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option><option value="‡¶°‡¶ø‡¶Æ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø">‡¶°‡¶ø‡¶Æ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option><option value="‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø">‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option>`;
                amtDiv.style.display = 'block';
            } else {
                cat.innerHTML = `<option value="‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®">‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ)</option><option value="‡¶Æ‡ßÉ‡¶§‡ßç‡¶Ø‡ßÅ">‡¶Æ‡ßÉ‡¶§‡ßç‡¶Ø‡ßÅ (‡¶ï‡ßç‡¶∑‡¶§‡¶ø)</option>`;
                amtDiv.style.display = 'none';
            }
        }

        function saveEntry() {
            const qty = parseFloat(document.getElementById('f-qty').value) || 0;
            const amt = parseFloat(document.getElementById('f-amt').value) || 0;
            
            if(qty <= 0 && STATE.currentTab === 'stock') return alert('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®');

            const entry = {
                id: Date.now(),
                batch: STATE.activeBatch,
                tab: STATE.currentTab,
                date: document.getElementById('f-date').value,
                cat: document.getElementById('f-cat').value,
                qty: qty,
                amt: amt
            };

            STATE.entries.push(entry);
            saveToDisk();
            document.getElementById('entry-form').reset();
            document.getElementById('f-date').valueAsDate = new Date();
            refreshUI();
        }

        function deleteEntry(id) {
            if(confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶°‡¶æ‡¶ü‡¶æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                STATE.entries = STATE.entries.filter(e => e.id !== id);
                saveToDisk();
                refreshUI();
            }
        }

        function saveToDisk() {
            localStorage.setItem('poultry_batches', JSON.stringify(STATE.batches));
            localStorage.setItem('poultry_data', JSON.stringify(STATE.entries));
        }

        function refreshUI() {
            document.getElementById('form-batch-badge').innerText = STATE.activeBatch;
            const currentData = STATE.entries.filter(e => e.batch === STATE.activeBatch);
            const filter = document.getElementById('table-filter').value;
            
            let totalIn = 0, totalOut = 0, stock = 0;
            
            currentData.forEach(e => {
                if(e.tab === 'income') totalIn += e.amt;
                if(e.tab === 'expense') totalOut += e.amt;
                if(e.tab === 'stock') {
                    stock += (e.cat === '‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®' ? e.qty : -e.qty);
                }
            });

            document.getElementById('kpi-income').innerText = `‡ß≥ ${totalIn.toLocaleString()}`;
            document.getElementById('kpi-expense').innerText = `‡ß≥ ${totalOut.toLocaleString()}`;
            document.getElementById('kpi-profit').innerText = `‡ß≥ ${(totalIn - totalOut).toLocaleString()}`;
            document.getElementById('kpi-stock').innerText = `${stock} ‡¶ü‡¶ø`;

            // Table Rendering
            const displayData = filter === 'all' ? currentData : currentData.filter(e => e.tab === filter);
            const tbody = document.getElementById('transaction-body');
            tbody.innerHTML = displayData.sort((a,b) => new Date(b.date) - new Date(a.date)).map(e => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-5 py-3 font-mono text-[11px]">${e.date}</td>
                    <td class="px-5 py-3 font-medium">${e.cat}</td>
                    <td class="px-5 py-3 text-right font-bold ${e.tab === 'income' ? 'text-emerald-600' : e.tab === 'expense' ? 'text-rose-600' : 'text-amber-600'}">
                        ${e.tab === 'stock' ? e.qty + ' ‡¶ü‡¶ø' : '‡ß≥ ' + e.amt.toLocaleString()}
                    </td>
                    <td class="px-5 py-3 text-center no-print">
                        <button onclick="deleteEntry(${e.id})" class="p-1 hover:bg-rose-50 rounded text-rose-400">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            updateChart(totalIn, totalOut);
        }

        function updateChart(inc, exp) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡¶Ü‡ßü', '‡¶¨‡ßç‡¶Ø‡ßü'],
                    datasets: [{
                        data: [inc || 1, exp || 0.1], // dummy values to show chart if empty
                        backgroundColor: ['#10b981', '#f43f5e'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Noto Sans Bengali' } } }
                    },
                    cutout: '70%'
                }
            });
        }

        // PDF Export Fixes
        async function downloadPDF() {
            const element = document.getElementById('report-content');
            const pdfHeader = document.getElementById('pdf-header');
            
            // Header for PDF
            document.getElementById('pdf-batch-info').innerText = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡¶Ç: ${STATE.activeBatch}`;
            document.getElementById('pdf-date-info').innerText = `‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleDateString('bn-BD')}`;
            
            pdfHeader.classList.remove('hidden');

            const opt = {
                margin: 0.3,
                filename: `Farm_Report_${STATE.activeBatch}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    letterRendering: true,
                    scrollY: 0
                },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            try {
                // PDF ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø CSS ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                await html2pdf().set(opt).from(element).save();
            } catch (err) {
                console.error("PDF Error:", err);
            } finally {
                pdfHeader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
