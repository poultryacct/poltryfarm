<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßã‡¶≤‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡ßã - ‡¶π‡¶æ‡¶á ‡¶∞‡ßá‡¶ú‡ßÅ‡¶≤‡ßá‡¶∂‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            background-color: #F8FAFC;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 180px;
        }
        .tab-btn.active {
            background-color: #059669;
            color: white;
        }
        @media print {
            .no-print { display: none !important; }
        }
        /* PDF Specific Styling */
        .pdf-page {
            background: white;
            padding: 20px;
        }
    </style>
</head>
<body class="text-slate-800 pb-10">

    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-3xl">üê§</span>
                <div>
                    <h1 class="text-lg font-bold text-emerald-800 leading-tight">‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã</h1>
                    <p class="text-[10px] text-slate-500 font-bold">‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="downloadHighResPDF()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg flex items-center gap-2 transition-all shadow-lg font-bold text-sm">
                    üì• ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° PDF (HD)
                </button>
                <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                    <select id="batch-selector" onchange="switchBatch()" class="bg-transparent text-emerald-700 font-bold text-sm py-1 px-2 border-0 focus:ring-0">
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <div id="capture-area" class="p-4 max-w-7xl mx-auto space-y-6">
        
        <!-- Dashboard Header for PDF -->
        <div id="pdf-header" class="hidden text-center pb-6 border-b-2 border-emerald-100">
            <h1 class="text-2xl font-black text-slate-800">‡¶™‡ßã‡¶≤‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h1>
            <p id="pdf-batch-name" class="text-emerald-600 font-bold"></p>
            <p id="pdf-timestamp" class="text-slate-400 text-xs mt-1"></p>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 border-l-4 border-emerald-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</p>
                <h3 class="text-2xl font-black text-emerald-600" id="kpi-income">‡ß≥ ‡ß¶</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 border-l-4 border-rose-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡ßü</p>
                <h3 class="text-2xl font-black text-rose-600" id="kpi-expense">‡ß≥ ‡ß¶</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 border-l-4 border-blue-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">‡¶≤‡¶æ‡¶≠/‡¶ï‡ßç‡¶∑‡¶§‡¶ø</p>
                <h3 class="text-2xl font-black text-slate-700" id="kpi-profit">‡ß≥ ‡ß¶</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 border-l-4 border-amber-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï</p>
                <h3 class="text-2xl font-black text-amber-600" id="kpi-stock">‡ß¶ ‡¶ü‡¶ø</h3>
            </div>
        </div>

        <!-- Entry Form (Hidden in PDF) -->
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 no-print">
            <div class="bg-slate-50 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 text-sm">‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
                <div class="flex bg-slate-200 p-1 rounded-xl">
                    <button onclick="setTab('expense')" id="tab-expense" class="tab-btn active px-4 py-1.5 rounded-lg text-[11px] font-bold transition-all">‡¶¨‡ßç‡¶Ø‡ßü</button>
                    <button onclick="setTab('income')" id="tab-income" class="tab-btn px-4 py-1.5 rounded-lg text-[11px] font-bold transition-all">‡¶Ü‡ßü</button>
                    <button onclick="setTab('stock')" id="tab-stock" class="tab-btn px-4 py-1.5 rounded-lg text-[11px] font-bold transition-all">‡¶∏‡ßç‡¶ü‡¶ï</button>
                </div>
            </div>
            <div class="p-6">
                <form id="entry-form" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="f-date" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                        <select id="f-cat" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm font-medium"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                        <input type="number" id="f-qty" oninput="autoCalc()" placeholder="‡ß¶" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm font-bold">
                    </div>
                    <div class="space-y-1" id="div-rate">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶¶‡¶∞ (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                        <input type="number" id="f-rate" oninput="autoCalc()" placeholder="‡ß¶" class="w-full px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm font-bold">
                    </div>
                    <div class="space-y-1" id="div-total">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ</label>
                        <input type="number" id="f-total" readonly class="w-full px-3 py-2 rounded-lg bg-emerald-50 border border-emerald-100 text-sm font-black text-emerald-700">
                    </div>
                    <button type="button" onclick="saveEntry()" class="bg-emerald-600 text-white font-bold py-2 rounded-lg hover:bg-emerald-700 shadow-md text-sm">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </form>
            </div>
        </section>

        <!-- Main Content Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Table Section -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-5 py-4 bg-slate-50 border-b border-slate-200">
                    <h3 class="font-bold text-sm text-slate-700">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-50 text-slate-500 border-b border-slate-200 font-bold">
                            <tr>
                                <th class="px-5 py-4">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th class="px-5 py-4">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th class="px-5 py-4 text-center">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                <th class="px-5 py-4 text-right">‡¶¶‡¶∞</th>
                                <th class="px-5 py-4 text-right">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                <th class="px-5 py-4 text-center no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Summary Chart Section -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-[11px] text-slate-400 uppercase mb-6">‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü</h3>
                <div class="chart-container">
                    <canvas id="financeChart"></canvas>
                </div>
                <div class="mt-8 space-y-3">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-500">‡¶Ü‡ßü ‡¶π‡¶æ‡¶∞:</span>
                        <span id="income-percent" class="font-bold text-emerald-600">‡ß¶%</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div id="income-bar" class="bg-emerald-500 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STATE = {
            batches: JSON.parse(localStorage.getItem('p_batches_v3')) || ['Batch-01'],
            activeBatch: localStorage.getItem('p_active_v3') || 'Batch-01',
            entries: JSON.parse(localStorage.getItem('p_data_v3')) || [],
            currentTab: 'expense'
        };

        let myChart = null;

        window.onload = () => {
            document.getElementById('f-date').valueAsDate = new Date();
            updateBatchList();
            setTab('expense');
            refreshUI();
        };

        function updateBatchList() {
            const el = document.getElementById('batch-selector');
            el.innerHTML = STATE.batches.map(b => `<option value="${b}">${b}</option>`).join('');
            el.value = STATE.activeBatch;
        }

        function switchBatch() {
            STATE.activeBatch = document.getElementById('batch-selector').value;
            localStorage.setItem('p_active_v3', STATE.activeBatch);
            refreshUI();
        }

        function setTab(tab) {
            STATE.currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const cat = document.getElementById('f-cat');
            const rateDiv = document.getElementById('div-rate');
            const totalDiv = document.getElementById('div-total');
            
            if(tab === 'expense') {
                cat.innerHTML = `<option value="‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞">‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞</option><option value="‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ">‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ</option><option value="‡¶î‡¶∑‡¶ß">‡¶î‡¶∑‡¶ß</option><option value="‡¶≤‡ßá‡¶¨‡¶æ‡¶∞">‡¶≤‡ßá‡¶¨‡¶æ‡¶∞</option><option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö</option>`;
                rateDiv.style.display = 'block';
                totalDiv.style.display = 'block';
            } else if(tab === 'income') {
                cat.innerHTML = `<option value="‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø">‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option><option value="‡¶°‡¶ø‡¶Æ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø">‡¶°‡¶ø‡¶Æ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option><option value="‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø">‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</option>`;
                rateDiv.style.display = 'block';
                totalDiv.style.display = 'block';
            } else {
                cat.innerHTML = `<option value="‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®">‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶® (+)</option><option value="‡¶Æ‡ßÉ‡¶§‡ßç‡¶Ø‡ßÅ">‡¶Æ‡ßÉ‡¶§‡ßç‡¶Ø‡ßÅ (-)</option>`;
                rateDiv.style.display = 'none';
                totalDiv.style.display = 'none';
            }
            autoCalc();
        }

        function autoCalc() {
            const qty = parseFloat(document.getElementById('f-qty').value) || 0;
            const rate = parseFloat(document.getElementById('f-rate').value) || 0;
            document.getElementById('f-total').value = (qty * rate) || '';
        }

        function saveEntry() {
            const qty = parseFloat(document.getElementById('f-qty').value) || 0;
            const rate = parseFloat(document.getElementById('f-rate').value) || 0;
            
            if(qty <= 0) return;

            STATE.entries.push({
                id: Date.now(),
                batch: STATE.activeBatch,
                tab: STATE.currentTab,
                date: document.getElementById('f-date').value,
                cat: document.getElementById('f-cat').value,
                qty: qty,
                rate: rate,
                total: STATE.currentTab === 'stock' ? 0 : (qty * rate)
            });

            localStorage.setItem('p_data_v3', JSON.stringify(STATE.entries));
            document.getElementById('f-qty').value = '';
            document.getElementById('f-rate').value = '';
            autoCalc();
            refreshUI();
        }

        function deleteEntry(id) {
            STATE.entries = STATE.entries.filter(e => e.id !== id);
            localStorage.setItem('p_data_v3', JSON.stringify(STATE.entries));
            refreshUI();
        }

        function refreshUI() {
            const data = STATE.entries.filter(e => e.batch === STATE.activeBatch);
            let inc = 0, exp = 0, stock = 0;

            data.forEach(e => {
                if(e.tab === 'income') inc += e.total;
                if(e.tab === 'expense') exp += e.total;
                if(e.tab === 'stock') stock += (e.cat === '‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®' ? e.qty : -e.qty);
            });

            document.getElementById('kpi-income').innerText = `‡ß≥ ${inc.toLocaleString()}`;
            document.getElementById('kpi-expense').innerText = `‡ß≥ ${exp.toLocaleString()}`;
            document.getElementById('kpi-profit').innerText = `‡ß≥ ${(inc - exp).toLocaleString()}`;
            document.getElementById('kpi-stock').innerText = `${stock} ‡¶ü‡¶ø`;

            // Progress bar calc
            const totalCash = inc + exp;
            const incPer = totalCash > 0 ? Math.round((inc / totalCash) * 100) : 0;
            document.getElementById('income-percent').innerText = `${incPer}%`;
            document.getElementById('income-bar').style.width = `${incPer}%`;

            document.getElementById('transaction-body').innerHTML = data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(e => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-5 py-4 font-bold text-slate-400">${e.date}</td>
                    <td class="px-5 py-4 font-bold text-slate-700">${e.cat}</td>
                    <td class="px-5 py-4 text-center font-bold">${e.qty}</td>
                    <td class="px-5 py-4 text-right text-slate-500">${e.tab==='stock'?'-':'‡ß≥'+e.rate}</td>
                    <td class="px-5 py-4 text-right font-black ${e.tab==='income'?'text-emerald-600':'text-rose-600'}">${e.tab==='stock'?'-':'‡ß≥'+e.total}</td>
                    <td class="px-5 py-4 text-center no-print">
                        <button onclick="deleteEntry(${e.id})" class="opacity-30 hover:opacity-100">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            updateChart(inc, exp);
        }

        function updateChart(inc, exp) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡¶Ü‡ßü', '‡¶¨‡ßç‡¶Ø‡ßü'],
                    datasets: [{
                        data: [inc || 1, exp || 0.1],
                        backgroundColor: ['#10b981', '#f43f5e'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, cutout: '80%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        function downloadHighResPDF() {
            const element = document.getElementById('capture-area');
            const header = document.getElementById('pdf-header');
            
            // Prepare PDF content
            header.classList.remove('hidden');
            document.getElementById('pdf-batch-name').innerText = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö: ${STATE.activeBatch}`;
            document.getElementById('pdf-timestamp').innerText = `‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø: ${new Date().toLocaleString('bn-BD')}`;

            const opt = {
                margin: [0.3, 0.3],
                filename: `Poultry_Report_${STATE.activeBatch}.pdf`,
                image: { type: 'jpeg', quality: 1 }, // Highest quality
                html2canvas: { 
                    scale: 3, // HD Scaling (3x)
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: false // Disable compression for quality
                }
            };

            // Execute PDF generation
            html2pdf().set(opt).from(element).save().then(() => {
                header.classList.add('hidden');
            });
        }
    </script>
</body>
</html>
